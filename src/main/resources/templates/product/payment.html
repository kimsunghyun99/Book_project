<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <meta charset="UTF-8">
    <title>쇼핑몰</title>


    <style>

        .tableDiv {
            text-align: center;
        }

        .InfoTable {
            border-collapse: collapse;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        .InfoTable th {
            border-bottom: 3px solid #168;
            color: #168;
            background: #f0f6f9;
            text-align: left;
        }
        .InfoTable th, .InfoTable td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        .InfoTable th:first-child, .InfoTable td:first-child {
            border-left: 0;
        }
        .InfoTable th:last-child, .InfoTable td:last-child {
            border-right: 0;
        }
        .InfoTable tr td:first-child{
            text-align: left;
        }
        .InfoTable caption{caption-side: top; }

        body {
            font-family: Arial, sans-serif;
        }


        .p_image {
            max-width: 30%;
            height: auto;
            display: block;
            margin: auto;
        }

        .c_info {
            width: 80%;
            border:none;
            border-bottom: 2px solid #adadad;
            margin: 5px;
            padding: 10px 10px;
            outline:none;
            color: #636e72;
            font-size:16px;
            height:25px;
            background: none;
        }

        .c_infoNames {
            width: 80px;
            height: 20px;
            margin: 5px;
            padding: 10px 10px;
            color:  #168;
            font-size:16px;
            font-weight: bold;
            background: #f0f6f9;
            display:inline-block;
        }

        #btn_addrSearch {
            width: 80px;
            height: 20px;
            margin: 5px;
            padding: 10px 10px;
            color:  white;
            font-size:16px;
            font-weight: bold;
            background: #168;
            display:inline-block;
            cursor: pointer;
        }

        .btn_order  {
            width:600px;
            height:40px;
            background: #168;
            color:white;
            font-weight: bold;
            border:none;
            cursor:pointer;

        }

        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 16px;
            box-sizing: border-box;
        }


        #ADDorDelete {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px; /* 원하는 여백 값으로 조절하세요 */
        }

        #add {
            width:60px;
            font-size: 14px; /* 원하는 글자 크기로 조절하세요 */
            padding: 5px 10px; /* 원하는 패딩 값으로 조절하세요 */
            margin-left: 5px; /* 각 버튼 사이 여백 조절 */
            text-align:center;
        }
        #addplus {
            display: none;
        }

        table {

            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 5px;
        }

        #pay {

            display: flex;
            justify-content: center;
            align-items: center;
          /*//  height: 70vh; !* 화면의 100% 높이로 설정하여 가운데 정렬 *!*/
        }

    </style>
<!--&lt;!&ndash;    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>&ndash;&gt;-->
<!--&lt;!&ndash;    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.8.js"></script>&ndash;&gt;-->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<!--&lt;!&ndash;    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>&ndash;&gt;-->


    <script>


        let addplusVisible = false;
        const AddAddr = () => {
            if (addplusVisible) {
                addplus.style.display = 'none'; // 이미 보이는 상태면 감추기
            } else {
                addplus.style.display = 'block'; // 안 보이는 상태면 보이기
            }

            addplusVisible = !addplusVisible; // 상태를 토글

        }


        const searchAddr = () => {

            if(addrSearch.value == '') {
                alert("검색할 주소를 입력하세요");
                addrSearch.focus();
                return false;
            }

            window.open(
                "/member/addrSearch?page=1&addrSearch=" + addrSearch.value,
                "주소검색",
                "width=950, height=540, top=50, left=50"
            );
        }





        const finaldelivery = (index) => {
            const original_addr = document.getElementById('original_addr' + index).innerText;
            const finaladdr = document.getElementById("finaladdr");
            finaladdr.innerText = "배송될 주소 : " + original_addr;
        }

        const finaldelivery1 = (addr1, detailaddr) => {

            const finaladdr = document.getElementById("finaladdr");
            finaladdr.innerText = "배송될 주소 : " + addr1 + "" + detailaddr;
        }


        // const KGpay = () => {
        //     const data = {
        //         pg: 'html5_inicis',
        //         pay_method: 'card',
        //         merchant_uid: this.userid + '_' + new Date().getTime(),
        //         name: '주문명:결제테스트',
        //         amount: this.price,
        //         buyer_email: this.userid,
        //         buyer_name: this.username,
        //         buyer_tel: this.telno,
        //         buyer_addr: '주소',
        //         buyer_postcode: '우편번호'
        //     }
        // };
        function KGpay() {
            // IMP 객체가 전역 범위에 정의되어 있다고 가정합니다.
            IMP.init("imp61517557");

            // 각 요소에 대한 참조를 가져오기 전에 변수로 선언해보세요.
            var buyerName = document.getElementById("buyerName");
            var deliveryName = document.getElementById("deliveryname");
            var totalInvoiceAmount = '1';
            var buyerEmail = document.getElementById("buyerEmail");
            var receiver = document.getElementById("receiver");
            var receiverTelNo = document.getElementById("receivertelno");
            var addr1 = document.getElementById("addr1");
            var detailAddr = document.getElementById("detailaddr");
            var zipcode = document.getElementById("zipcode");

            // 참조를 가져온 후에 값을 읽어보세요.
            var merchantUid = buyerName ? buyerName.value + new Date().getTime() : null;
            var name = deliveryName ? deliveryName.value : null;
            var amount = '1';
            var email = buyerEmail ? buyerEmail.value : null;
            var buyer = receiver ? receiver.value : null;
            var telNo = receiverTelNo ? receiverTelNo.value : null;
            var address = addr1 && detailAddr ? addr1.value + " " + detailAddr.value : null;
            var postcode = zipcode ? zipcode.value : null;

            IMP.request_pay({
                pg: "html5_inicis",
                pay_method: "card",
                merchant_uid: 'order_no_0001',
                name: '책',
                amount: '1',
                buyer_email: 'ponyodevdev@gmail.com',
                buyer_name: '포뇨',
                buyer_tel: '010-1234-5678',
                buyer_addr: '서울특별시 강남구 삼성동',
                buyer_postcode:  '123-456'
            }, function (rsp) {
                // if (rsp.success) {
                //     // 결제 성공 시 처리 로직
                //     console.log("Payment success:", rsp);
                //     // 여기에 결제 성공 시 수행할 로직을 추가하세요.
                // } else {
                //     // 결제 실패 시 처리 로직
                //     alert("결재 실패");
                //     alert(rsp.error_msg);
                //     console.log(rsp);
                // }

                // });
                if (rsp.success) { // 결제 성공 시: 결제 승인 또는 가상계좌 발급에 성공한 경우
                    // jQuery로 HTTP 요청
                    jQuery.ajax({
                        url: "/api/order/payment/complete", // 가맹점 서버
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        data: {
                            imp_uid: rsp.imp_uid,
                            merchant_uid: rsp.merchant_uid
                            //기타 필요한 데이터가 있으면 추가 전달
                        }
                    }).done(function (data) {
                        // 가맹점 서버 결제 API 성공시 로직
                        swal({
                            text: data,  // 서버로부터의 결과 메시지
                            closeOnClickOutside: false
                        })
                            .then(function () {
                                // "/orderList" 페이지로 리디렉션
                                location.replace("/main");
                            });
                    })
                        .fail(function () {
                            // 이 블록은 AJAX 요청이 실패할 때 실행됩니다.

                            // 에러를 나타내는 경고 표시
                            alert("에러");

                            // 루트("/") 페이지로 리디렉션
                            // location.replace("/");
                        });
                    //         })
                    //     } else {
                    //         alert("결제에 실패하였습니다. 에러 내용: " +  rsp.error_msg);
                    //     }
                    // });
                }
            });
        }
        // function paymentComplete(data) {
        //
        //     $.ajax({
        //         url: "/api/order/payment/complete",
        //         method: "POST",
        //         data: data,
        //     })
        //         .done(function(result) {
        //             messageSend();
        //             swal({
        //                 text: result,
        //                 closeOnClickOutside : false
        //             })
        //                 .then(function(){
        //                     location.replace("/orderList");
        //                 })
        //         }) // done
        //         .fail(function() {
        //             alert("에러");
        //             location.replace("/");
        //         })
        // }

        const requestData = {
            merchant_uid: "order_no_0001", // 가맹점 주문번호
            amount: 1, // 결제 예정금액
        };

        fetch("https://api.iamport.kr/payments/prepare", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
        })
            .then((response) => response.json())
            .then((data) => {
                // 성공적인 응답 처리
                console.log(data);
            })
            .catch((error) => {
                // 오류 처리
                console.error("Error:", error);
            });


        async function completePayment() {
            try {
                // req의 body에서 imp_uid, merchant_uid 추출
                const imp_uid = 'imp61517557'; // 여기에 실제 값 입력
                const merchant_uid = 'order_no_0001'; // 여기에 실제 값 입력

                // 액세스 토큰(access token) 발급 받기
                const getToken = await fetch("https://api.iamport.kr/users/getToken", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        imp_key: "3557360680577444", // REST API 키
                        imp_secret: "X1zURcFH3XOO3Uy6B4aB5cdUAEQ0sZRG9ui7jvPerNWKfD1ELpw2v20afZGurR2njETUGylUME6eiC38" // REST API Secret
                    })
                });
                const { access_token } = await getToken.json(); // 인증 토큰

                // imp_uid로 포트원 서버에서 결제 정보 조회
                const getPaymentData = await fetch(`https://api.iamport.kr/payments/${imp_uid}`, {
                    method: "GET",
                    headers: { "Authorization": access_token }
                });
                const paymentData = await getPaymentData.json(); // 조회한 결제 정보

                // 나머지 로직 추가

                console.log("Payment complete");
            } catch (e) {
                console.error(e.message);
            }
        }

        // 호출 예시
        completePayment();

        function requestPayment() {
            // 결제에 필요한 정보를 수집합니다.
            var paymentInfo = {
                // 여기에 결제에 필요한 정보를 추가하세요
            };

            // 서버로 결제 요청을 전송합니다.
            fetch("/api/order/payment/complete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(paymentInfo)
            })
                .then(response => response.json())
                .then(data => {
                    // 서버로부터의 응답을 처리합니다.
                    console.log(data);

                    // 응답에 따른 클라이언트의 동작을 수행하세요.
                    if (data.status === "success") {
                        // 결제가 성공적으로 처리되었을 때의 동작
                        alert("결제가 성공적으로 완료되었습니다.");
                        // 원하는 동작 수행
                    } else {
                        // 결제가 실패했을 때의 동작
                        alert("결제에 실패했습니다.");
                        // 원하는 동작 수행
                    }
                })
                .catch(error => {
                    // 오류 처리
                    console.error("Error:", error);
                });
        }



    </script>


</head>

<body>

<div class="mall">
    <div class="main_shop">

        <h1>주문서</h1><br>
        <div class="tableDiv">
            <table class="InfoTable">
                <tr>
                    <th>주문상품</th>
                    <th>책 이름</th>
                    <th>저자</th>
                    <th>책 가격</th>
                    <th>수량</th>
                </tr>

                <tbody>
                <tr th:each="view : ${view}">
                    <td><img class="p_image" th:src="${view.cover}" alt="책 표지 이미지" style="width:300px; height: auto"></td>
                    <td><span th:text="${view.bookname}"></span></td>
                    <td><span th:text="${view.author}"></span></td>
                    <td><span th:id="price" th:text="${#numbers.formatInteger(view.price,3,'COMMA')+'원'}"></span></td>
<!--                    <td>1</td>-->
<!--                    <td><span th:text="${view.order_quantity}"></span></td>-->
<!--                    <td><span class="invoiceAmount" th:text="${#numbers.formatInteger(list.order_amount,3,'COMMA')+'원'}"></span></td>-->
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td colspan="3"><span style="text-align:right"><h2>합계 : <span id="totalInvoiceAmount" style="text-align:right"></span>1원</h2></span></td>
                </tr>
                </tbody>
            </table>
        </div>
        <br>
        <h4 style="display: inline-block;">배송지 목록</h4>
        <div id="ADDorDelete" style="display: inline-block;">
            <input type="button" id="add" value="새로운 배송지" onclick="AddAddr()" style="width:120%;">
        </div>

        <table class="InfoTable" style="border-width: 2px; border-style: solid;">
            <thead>
            <tr>
                <th>받는사람</th>
                <th>주소</th>
                <th>우편번호</th>
                <th>번호</th>
                <th>선택</th>
            </tr>
            </thead>
            <tbody>
            <th:block th:if="${delverylist != null}">
                <tr th:each="delivery, stat :${delverylist}">
                    <td th:id="deliveryname" th:text="${delivery.name}"></td>
                    <td th:id="'original_addr' + ${stat.index}" th:text="${delivery.addr} + ' ' + ${delivery.detailaddr}"></td>
                    <td th:text="${delivery.zipcode}"></td>
                    <td th:text="${delivery.telno}"></td>
                    <td><input type="button" style="text-align: center;" value="선택" th:onclick="'finaldelivery(' + ${stat.index} + ')'"></td>
                    <input type="hidden" id="deleteseqno" th:value="${delivery.deliveryseq}">
                    <!--                <span style="display: none" id="deleteseqno" th:value="${delverylist.deliveryseq}"></span>-->
                </tr>
            </th:block>
            </tbody>
        </table>
        <br><br>
        <div id="addplus">
            <input type="text" id="addrSearch" name="addrSearch" class="addrSearch" placeholder="주소를 검색합니다.">
            <input type="button" id="btn_addSearch" class="btn_addrSearch" value="주소검색" onclick="searchAddr()">
            <input type="text" id="zipcode" class="input_field" name="zipcode" placeholder="우편번호가 검색되어 입력됩니다." readonly>
            <input type="text" id="addr1" class="input_field" name="addr1" placeholder="주소가 검색되어 입력됩니다." readonly>
            <input type="text" id="detailaddr" class="input_field" name="detailaddr" placeholder="상세 주소를 입력하세요">
            <input type="text" id="receiver" class="input_field" name="receiver" placeholder="받는사람 이름을 입력하세요">
            <input type="text" id="receivertelno" class="input_field" name="receivertelno" placeholder="받는사람 번호를 입력하세요">
            <input type="button" id="newdelivery" class="input_field" value="선택" onclick="finaldelivery1(document.getElementById('addr1').value, document.getElementById('detailaddr').value)">
        </div>
        <br><br><br>

        <span id="finaladdr">배송될 주소 : </span>


        <br><br><br><br>


            <div id="pay">
                <input type="button" style="text-align: center" class="btn_order" value="결제하기" onclick="KGpay()">
            </div>

    </div>
</div>
<br><br><br><br>
</body>
</html>
